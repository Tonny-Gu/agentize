name: Add issues and PRs to project

on:
  issues:
    types:
      - opened
  pull_request:
    types:
      - opened
      - closed

env:
  PROJECT_ORG: Synthesys-Lab  # Replace with your GitHub organization
  PROJECT_ID: 3  # Replace with your project number (e.g., 3)
  STAGE_FIELD_ID: YOUR_STAGE_FIELD_ID_HERE  # Replace with your Stage field ID (e.g., PVTSSF_xxx)

jobs:
  add-to-project:
    name: Add to project
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      # Add issues to project with Stage "proposed"
      - name: Add issue to project
        if: github.event_name == 'issues'
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/${{ env.PROJECT_ORG }}/projects/${{ env.PROJECT_ID }}
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          status-field: Stage
          status-value: proposed

      # Add PRs to project without setting status
      - name: Add PR to project
        if: github.event_name == 'pull_request'
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/${{ env.PROJECT_ORG }}/projects/${{ env.PROJECT_ID }}
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

  close-linked-issues:
    name: Close linked issues
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Get linked issues
        id: get-issues
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          # Query PR for linked issues using closingIssuesReferences
          pr_number="${{ github.event.pull_request.number }}"
          repo_owner="${{ github.repository_owner }}"
          repo_name="${{ github.event.repository.name }}"

          echo "Querying linked issues for PR #$pr_number..."

          linked_issues=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $prNumber: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $prNumber) {
                  closingIssuesReferences(first: 10) {
                    nodes {
                      number
                      id
                    }
                  }
                }
              }
            }
          ' -f owner="$repo_owner" -f repo="$repo_name" -F prNumber="$pr_number" --jq '.data.repository.pullRequest.closingIssuesReferences.nodes')

          echo "linked_issues<<EOF" >> $GITHUB_OUTPUT
          echo "$linked_issues" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Found linked issues:"
          echo "$linked_issues" | jq -r '.[] | "  - Issue #\(.number) (ID: \(.id))"'

      - name: Close linked issues
        if: steps.get-issues.outputs.linked_issues != '[]'
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT }}
        run: |
          linked_issues='${{ steps.get-issues.outputs.linked_issues }}'

          # Process each linked issue
          echo "$linked_issues" | jq -c '.[]' | while read -r issue; do
            issue_number=$(echo "$issue" | jq -r '.number')
            echo "Closing issue #$issue_number..."
            gh issue close $issue_number --reason "completed"
            echo "  âœ… Issue #$issue_number closed"
          done

          echo ""
          echo "All linked issues closed successfully!"
