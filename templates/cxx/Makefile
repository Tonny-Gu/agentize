.PHONY: setup build clean test pre-commit env env-script help

pre-commit:
	@if [ -f scripts/pre-commit ]; then \
		HOOKS_DIR=$$(git rev-parse --git-path hooks 2>/dev/null || echo ".git/hooks"); \
		mkdir -p "$$HOOKS_DIR"; \
		ln -sf ../../scripts/pre-commit "$$HOOKS_DIR/pre-commit"; \
		echo "âœ“ Pre-commit hook installed"; \
	else \
		echo "Error: scripts/pre-commit not found"; \
		exit 1; \
	fi

setup:
	@echo "Generating setup.sh script..."
	@echo "#!/bin/bash" > setup.sh
	@echo "# Environment setup script for C++ SDK" >> setup.sh
	@echo "# Generated by 'make setup'" >> setup.sh
	@echo "" >> setup.sh
	@echo "export SDK_ROOT=\"\$$(cd \"\$$(dirname \"\$$BASH_SOURCE\")\" && pwd)\"" >> setup.sh
	@echo "export SDK_INCLUDE=\"\$$SDK_ROOT/include\"" >> setup.sh
	@echo "export SDK_BUILD=\"\$$SDK_ROOT/build\"" >> setup.sh
	@echo "" >> setup.sh
	@echo "echo \"SDK environment variables set:\"" >> setup.sh
	@echo "echo \"  SDK_ROOT=\$$SDK_ROOT\"" >> setup.sh
	@echo "echo \"  SDK_INCLUDE=\$$SDK_INCLUDE\"" >> setup.sh
	@echo "echo \"  SDK_BUILD=\$$SDK_BUILD\"" >> setup.sh
	@chmod +x setup.sh
	@echo "setup.sh generated successfully"

# ============================================================================
# Environment Setup
# ============================================================================

env:
	@echo 'export PROJECT_ROOT="$(CURDIR)"'
	@echo 'export PATH="$(CURDIR)/build/bin:$$PATH"'
	@echo 'export CPLUS_INCLUDE_PATH="$(CURDIR)/include:$$CPLUS_INCLUDE_PATH"'
	@echo 'export LIBRARY_PATH="$(CURDIR)/build/lib:$$LIBRARY_PATH"'

env-script:
	@echo "Generating setup.sh..."
	@echo '#!/bin/bash' > setup.sh
	@echo '# Generated by make env-script' >> setup.sh
	@echo 'export PROJECT_ROOT="$(CURDIR)"' >> setup.sh
	@echo 'export PATH="$$PROJECT_ROOT/build/bin:$$PATH"' >> setup.sh
	@echo 'export CPLUS_INCLUDE_PATH="$$PROJECT_ROOT/include:$$CPLUS_INCLUDE_PATH"' >> setup.sh
	@echo 'export LIBRARY_PATH="$$PROJECT_ROOT/build/lib:$$LIBRARY_PATH"' >> setup.sh
	@chmod +x setup.sh
	@echo "Generated setup.sh - run: source setup.sh"

build:
	cmake -S . -B build && cmake --build build

clean:
	if [ -d build ]; then make -C build clean; fi

test: build
	cd build && ctest --output-on-failure

help:
	@echo "Available targets:"
	@echo "  make pre-commit  - Install pre-commit hook"
	@echo "  make setup       - Generate setup.sh (legacy)"
	@echo "  make env         - Print environment exports (use: eval \$$(make env))"
	@echo "  make env-script  - Generate setup.sh script"
	@echo "  make build       - Build the project"
	@echo "  make clean       - Clean build artifacts"
	@echo "  make test        - Run tests"
